<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SplitGenZ - Expense Splitter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #8a2be2;
      --secondary: #4f46e5;
      --accent: #ec4899;
      --dark: #1e293b;
      --light: #f8fafc;
    }
    
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
    }
    
    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: var(--accent);
      opacity: 0;
      z-index: 1000;
      animation: confettiFall 3s ease-in-out forwards;
    }
    
    .avatar-initials {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .group-avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    }
    
    .stacked-avatars {
      display: flex;
    }
    
    .stacked-avatars > * {
      margin-left: -10px;
      border: 2px solid white;
    }
    
    .stacked-avatars > *:first-child {
      margin-left: 0;
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #ec4899;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .context-menu {
      position: absolute;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 8px;
      z-index: 100;
      overflow: hidden;
    }
    
    .context-item {
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    
    .context-item:hover {
      background: #f9fafb;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm py-4 px-6 flex justify-between items-center">
    <div class="flex items-center">
      <i class="fas fa-money-bill-wave text-2xl text-purple-600 mr-2"></i>
      <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-600">
        SplitGenZ
      </h1>
    </div>
    <div class="flex items-center space-x-4 relative">
      <div id="notificationIcon" class="relative cursor-pointer hidden">
        <i class="fas fa-bell text-xl text-gray-600"></i>
        <span id="notificationCount" class="notification-badge">0</span>
      </div>
      <div id="userProfile" class="hidden flex items-center">
        <div id="userAvatar" class="w-10 h-10 rounded-full object-cover mr-2 avatar-initials"></div>
        <span id="username" class="font-medium">User123</span>
      </div>
      <button id="authBtn" class="btn-primary">
        <i class="fas fa-sign-in-alt mr-2"></i>Login
      </button>
    </div>
  </nav>

  <!-- Notification dropdown -->
  <div id="notificationDropdown" class="hidden absolute top-16 right-4 w-80 bg-white rounded-xl shadow-lg z-50">
    <div class="p-4 border-b">
      <h3 class="font-bold">Notifications</h3>
    </div>
    <div id="notificationList" class="max-h-80 overflow-y-auto">
      <!-- Notifications will appear here -->
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Panel - Friends & Groups -->
      <div class="col-span-1 space-y-6">
        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-user-friends mr-2 text-purple-500"></i>Friends
          </h2>
          <div id="friendsList" class="space-y-3">
            <!-- Dynamically populated -->
          </div>
          <button id="addFriendBtn" class="btn-primary w-full mt-4">
            <i class="fas fa-user-plus mr-2"></i> Add Friend
          </button>
        </div>

        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-users mr-2 text-purple-500"></i>Groups
          </h2>
          <div id="groupsList" class="space-y-3">
            <!-- Dynamically populated -->
          </div>
          <button id="createGroupBtn" class="btn-primary w-full mt-4">
            <i class="fas fa-plus mr-2"></i> Create Group
          </button>
        </div>

        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-bell mr-2 text-purple-500"></i>Activity Feed
          </h2>
          <div id="activityFeed" class="space-y-3">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>

      <!-- Center Panel - Expenses -->
      <div class="col-span-1 lg:col-span-2">
        <div class="card p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center">
              <i class="fas fa-receipt mr-2 text-purple-500"></i>Expenses
            </h2>
            <button id="addExpenseBtn" class="btn-primary">
              <i class="fas fa-plus mr-2"></i> Add Expense
            </button>
          </div>

          <div id="expensesContainer" class="space-y-4">
            <!-- Dynamically populated -->
          </div>
        </div>

        <!-- Settlements Section -->
        <div class="card p-6 mt-6">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-hand-holding-usd mr-2 text-purple-500"></i>Settlements
          </h2>
          <div id="settlementsContainer" class="space-y-3">
            <!-- Dynamically populated -->
          </div>
          <button id="settleUpBtn" class="btn-primary w-full mt-4">
            <i class="fas fa-check-circle mr-2"></i> Settle Up
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="py-6 text-center text-gray-600 text-sm">
    <p>© 2023 SplitGenZ. All rights reserved. Made with 💜 for Gen-Z</p>
  </footer>

  <!-- Modals -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="card w-full max-w-md p-8">
      <h2 class="text-2xl font-bold mb-6 text-center">Welcome to SplitGenZ</h2>
      <div id="loginForm" class="space-y-4">
        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border rounded-xl">
        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border rounded-xl">
        <button id="loginSubmit" class="btn-primary w-full">Login</button>
        <div class="text-center">
          <button id="showRegister" class="text-purple-600 font-medium">Create account</button>
        </div>
      </div>
      
      <div id="registerForm" class="space-y-4 hidden">
        <input type="text" id="registerUsername" placeholder="Username" class="w-full p-3 border rounded-xl">
        <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 border rounded-xl">
        <input type="password" id="registerPassword" placeholder="Password" class="w-full p-3 border rounded-xl">
        <button id="registerSubmit" class="btn-primary w-full">Create Account</button>
        <div class="text-center">
          <button id="showLogin" class="text-purple-600 font-medium">Already have an account?</button>
        </div>
      </div>
    </div>
  </div>

  <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="card w-full max-w-lg p-6">
      <h2 class="text-xl font-bold mb-4" id="expenseModalTitle">Add New Expense</h2>
      <form id="expenseForm" class="space-y-4">
        <div>
          <label class="block mb-1 font-medium">Description</label>
          <input type="text" id="expenseDesc" placeholder="Dinner, Rent, etc." class="w-full p-3 border rounded-xl" required>
        </div>
        
        <div>
          <label class="block mb-1 font-medium">Amount ($)</label>
          <input type="number" id="expenseAmount" placeholder="0.00" min="0.01" step="0.01" class="w-full p-3 border rounded-xl" required>
        </div>
        
        <div>
          <label class="block mb-1 font-medium">Category</label>
          <select id="expenseCategory" class="w-full p-3 border rounded-xl">
            <option value="Food">Food 🍔</option>
            <option value="Travel">Travel ✈️</option>
            <option value="Utilities">Utilities 💡</option>
            <option value="Entertainment">Entertainment 🎬</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div>
          <label class="block mb-1 font-medium">Paid By</label>
          <select id="expensePayer" class="w-full p-3 border rounded-xl">
            <!-- Populated dynamically -->
          </select>
        </div>
        
        <div>
          <label class="block mb-1 font-medium">Split Type</label>
          <select id="expenseSplitType" class="w-full p-3 border rounded-xl">
            <option value="EQUAL">Equally</option>
            <option value="PERCENTAGE">By Percentage</option>
            <option value="EXACT">Exact Amounts</option>
          </select>
        </div>
        
        <div id="splitDetails" class="space-y-3">
          <!-- Split details will be populated here -->
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelExpense" class="px-4 py-2 border rounded-xl">Cancel</button>
          <button type="submit" class="btn-primary" id="expenseSubmitBtn">Add Expense</button>
        </div>
      </form>
    </div>
  </div>

  <div id="friendModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="card w-full max-w-md p-6">
      <h2 class="text-xl font-bold mb-4">Add Friend</h2>
      <div class="space-y-4">
        <div>
          <label class="block mb-1 font-medium">Search by Email</label>
          <div class="flex">
            <input type="email" id="friendEmail" placeholder="friend@example.com" class="flex-grow p-3 border rounded-l-xl">
            <button id="searchFriend" class="bg-gray-100 px-4 rounded-r-xl">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        
        <div id="friendSearchResults" class="space-y-3 hidden">
          <!-- Results will appear here -->
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelFriend" class="px-4 py-2 border rounded-xl">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="groupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="card w-full max-w-md p-6">
      <h2 class="text-xl font-bold mb-4">Create Group</h2>
      <div class="space-y-4">
        <div>
          <label class="block mb-1 font-medium">Group Name</label>
          <input type="text" id="groupName" placeholder="Roommates, Trip Buddies, etc." class="w-full p-3 border rounded-xl">
        </div>
        
        <div>
          <label class="block mb-1 font-medium">Add Members</label>
          <div id="groupMembers" class="space-y-2 max-h-40 overflow-y-auto p-2 border rounded-xl">
            <!-- Friends will be listed here with checkboxes -->
          </div>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelGroup" class="px-4 py-2 border rounded-xl">Cancel</button>
          <button type="button" id="createGroup" class="btn-primary">Create Group</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Socket.IO
    const socket = io();
    
    // DOM Elements
    const authBtn = document.getElementById('authBtn');
    const authModal = document.getElementById('authModal');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const showRegister = document.getElementById('showRegister');
    const showLogin = document.getElementById('showLogin');
    const loginSubmit = document.getElementById('loginSubmit');
    const registerSubmit = document.getElementById('registerSubmit');
    const userProfile = document.getElementById('userProfile');
    const usernameSpan = document.getElementById('username');
    const userAvatar = document.getElementById('userAvatar');
    
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const expenseModal = document.getElementById('expenseModal');
    const expenseForm = document.getElementById('expenseForm');
    const expenseModalTitle = document.getElementById('expenseModalTitle');
    const expenseSubmitBtn = document.getElementById('expenseSubmitBtn');
    const cancelExpense = document.getElementById('cancelExpense');
    
    const addFriendBtn = document.getElementById('addFriendBtn');
    const friendModal = document.getElementById('friendModal');
    const cancelFriend = document.getElementById('cancelFriend');
    const searchFriendBtn = document.getElementById('searchFriend');
    
    const createGroupBtn = document.getElementById('createGroupBtn');
    const groupModal = document.getElementById('groupModal');
    const cancelGroup = document.getElementById('cancelGroup');
    const createGroup = document.getElementById('createGroup');
    
    const friendsList = document.getElementById('friendsList');
    const groupsList = document.getElementById('groupsList');
    const expensesContainer = document.getElementById('expensesContainer');
    const settlementsContainer = document.getElementById('settlementsContainer');
    const activityFeed = document.getElementById('activityFeed');
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationList = document.getElementById('notificationList');
    const notificationCount = document.getElementById('notificationCount');
    const settleUpBtn = document.getElementById('settleUpBtn');
    
    // State
    let currentUser = null;
    let authToken = null;
    let allUsers = [];
    let notifications = [];
    const API_BASE = window.location.origin;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
      setupEventListeners();
      
      // Notification handling
      notificationIcon.addEventListener('click', toggleNotifications);
      
      // Close notifications when clicking outside
      document.addEventListener('click', (e) => {
        if (!notificationDropdown.contains(e.target) && 
            !notificationIcon.contains(e.target)) {
          notificationDropdown.classList.add('hidden');
        }
      });
    });
    
    function setupEventListeners() {
      // Auth events
      authBtn.addEventListener('click', () => {
        if (currentUser) {
          logout();
        } else {
          authModal.classList.remove('hidden');
        }
      });
      
      showRegister.addEventListener('click', () => {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
      });
      
      showLogin.addEventListener('click', () => {
        registerForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
      });
      
      loginSubmit.addEventListener('click', loginHandler);
      registerSubmit.addEventListener('click', registerHandler);
      
      // Expense events
      addExpenseBtn.addEventListener('click', () => {
        if (!currentUser) {
          showAuthModal();
          return;
        }
        expenseModalTitle.textContent = 'Add New Expense';
        expenseSubmitBtn.textContent = 'Add Expense';
        expenseForm.dataset.expenseId = '';
        populatePayerDropdown();
        expenseModal.classList.remove('hidden');
      });
      
      cancelExpense.addEventListener('click', () => {
        expenseModal.classList.add('hidden');
      });
      
      expenseForm.addEventListener('submit', submitExpenseForm);
      
      // Friend events
      addFriendBtn.addEventListener('click', () => {
        if (!currentUser) {
          showAuthModal();
          return;
        }
        friendModal.classList.remove('hidden');
        document.getElementById('friendEmail').value = '';
        document.getElementById('friendSearchResults').innerHTML = '';
        document.getElementById('friendSearchResults').classList.add('hidden');
      });
      
      cancelFriend.addEventListener('click', () => {
        friendModal.classList.add('hidden');
      });
      
      searchFriendBtn.addEventListener('click', searchFriend);
      
      // Group events
      createGroupBtn.addEventListener('click', () => {
        if (!currentUser) {
          showAuthModal();
          return;
        }
        document.getElementById('groupName').value = '';
        populateGroupMembers();
        groupModal.classList.remove('hidden');
      });
      
      cancelGroup.addEventListener('click', () => {
        groupModal.classList.add('hidden');
      });
      
      createGroup.addEventListener('click', createGroupHandler);
      
      // Settlement event
      settleUpBtn.addEventListener('click', settleUpHandler);
      
      // Socket.io listeners
      socket.on('connect', () => {
        console.log('Connected to WebSocket server');
        if (currentUser) {
          socket.emit('register', currentUser._id);
        }
      });
      
      socket.on('friendRequest', (data) => {
        addNotification({
          type: 'friendRequest',
          message: `${data.from.username} sent you a friend request`,
          from: data.from,
          requestId: data._id
        });
      });
      
      socket.on('expenseAdded', (expense) => {
        if (expense.paidBy._id !== currentUser._id) {
          addNotification({
            type: 'expense',
            message: `${expense.paidBy.username} added expense: ${expense.description} ($${expense.amount.toFixed(2)})`,
            expenseId: expense._id
          });
        }
      });
      
      socket.on('settlement', (settlement) => {
        if (settlement.to === currentUser._id || settlement.from === currentUser._id) {
          const isReceiver = settlement.to === currentUser._id;
          const otherUser = isReceiver ? settlement.from : settlement.to;
          addNotification({
            type: 'settlement',
            message: `${isReceiver ? 'You received' : 'You sent'} a settlement of $${settlement.amount.toFixed(2)} ${isReceiver ? 'from' : 'to'} ${otherUser.username}`,
            settlementId: settlement._id
          });
        }
      });
    }
    
    function showAuthModal() {
      alert('Please login to access this feature');
      authModal.classList.remove('hidden');
    }
    
    // Notification functions
    function addNotification(notification) {
      notifications.unshift(notification);
      updateNotificationUI();
    }
    
    function updateNotificationUI() {
      notificationCount.textContent = notifications.length;
      notificationIcon.classList.toggle('hidden', notifications.length === 0);
      
      notificationList.innerHTML = '';
      notifications.forEach(notif => {
        const notifElement = document.createElement('div');
        notifElement.className = 'p-4 border-b hover:bg-gray-50 cursor-pointer';
        notifElement.innerHTML = `
          <p class="text-sm">${notif.message}</p>
          <p class="text-xs text-gray-500 mt-1">Just now</p>
        `;
        notificationList.appendChild(notifElement);
      });
    }
    
    function toggleNotifications() {
      notificationDropdown.classList.toggle('hidden');
      if (!notificationDropdown.classList.contains('hidden')) {
        notifications = [];
        updateNotificationUI();
      }
    }
    
    // API Functions
    async function checkAuthStatus() {
      const token = localStorage.getItem('splitgenz_token');
      const userId = localStorage.getItem('splitgenz_userId');
      
      if (token && userId) {
        try {
          const response = await fetch(`${API_BASE}/api/users/${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const userData = await response.json();
            currentUser = userData;
            authToken = token;
            updateUIAfterLogin();
            
            // Register with socket.io
            socket.emit('register', currentUser._id);
          }
        } catch (error) {
          console.error('Auth check failed:', error);
        }
      }
    }
    
    async function loginHandler() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      await loginUser(email, password);
    }
    
    async function registerHandler() {
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      await registerUser(username, email, password);
    }
    
    async function loginUser(email, password) {
      try {
        const response = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = {
            _id: data._id,
            username: data.username,
            email: data.email,
            avatar: data.avatar,
            friends: data.friends || []
          };
          
          localStorage.setItem('splitgenz_token', authToken);
          localStorage.setItem('splitgenz_userId', currentUser._id);
          
          authModal.classList.add('hidden');
          updateUIAfterLogin();
        } else {
          alert(`Login failed: ${data.error}`);
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('Login failed. Please try again.');
      }
    }
    
    async function registerUser(username, email, password) {
      try {
        const response = await fetch(`${API_BASE}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentUser = {
            _id: data._id,
            username: data.username,
            email: data.email,
            avatar: data.avatar,
            friends: data.friends || []
          };
          
          localStorage.setItem('splitgenz_token', authToken);
          localStorage.setItem('splitgenz_userId', currentUser._id);
          
          authModal.classList.add('hidden');
          updateUIAfterLogin();
        } else {
          alert(`Registration failed: ${data.error}`);
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
      }
    }
    
    function logout() {
      localStorage.removeItem('splitgenz_token');
      localStorage.removeItem('splitgenz_userId');
      currentUser = null;
      authToken = null;
      
      authBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Login';
      userProfile.classList.add('hidden');
      
      // Clear data displays
      friendsList.innerHTML = '';
      groupsList.innerHTML = '';
      expensesContainer.innerHTML = '';
      settlementsContainer.innerHTML = '';
      activityFeed.innerHTML = '';
      notificationIcon.classList.add('hidden');
    }
    
    async function fetchData() {
      if (!currentUser) return;
      
      try {
        // Fetch users
        const usersRes = await fetch(`${API_BASE}/api/users`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (usersRes.ok) allUsers = await usersRes.json();
        
        // Fetch expenses
        const expensesRes = await fetch(`${API_BASE}/api/expenses`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (expensesRes.ok) {
          const expenses = await expensesRes.json();
          renderExpenses(expenses);
        }
        
        // Fetch settlements
        const settlementsRes = await fetch(`${API_BASE}/api/settlements`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (settlementsRes.ok) {
          const settlements = await settlementsRes.json();
          renderSettlements(settlements);
        }
        
        // Fetch balances
        const balancesRes = await fetch(`${API_BASE}/api/balances`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (balancesRes.ok) {
          const balances = await balancesRes.json();
          renderFriends(balances);
        }
        
        // Fetch groups
        const groupsRes = await fetch(`${API_BASE}/api/groups`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (groupsRes.ok) {
          const groups = await groupsRes.json();
          renderGroups(groups);
        }
        
        // Fetch friend requests
        const requestsRes = await fetch(`${API_BASE}/api/friend-requests`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (requestsRes.ok) {
          const requests = await requestsRes.json();
          renderFriendRequests(requests);
        }
        
      } catch (error) {
        console.error('Data fetch error:', error);
      }
    }
    
    async function submitExpenseForm(e) {
      e.preventDefault();
      
      const description = document.getElementById('expenseDesc').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const category = document.getElementById('expenseCategory').value;
      const paidBy = document.getElementById('expensePayer').value;
      const splitType = document.getElementById('expenseSplitType').value;
      const expenseId = expenseForm.dataset.expenseId;
      
      // Validate inputs
      if (!description || !amount || amount <= 0 || !paidBy) {
        alert('Please fill all required fields with valid values');
        return;
      }
      
      // Create shares array (simplified for demo)
      let shares = [];
      const shareAmount = amount / allUsers.length;
      
      shares = allUsers.map(user => ({
        user: user._id,
        amount: shareAmount
      }));
      
      const method = expenseId ? 'PUT' : 'POST';
      const url = expenseId ? 
        `${API_BASE}/api/expenses/${expenseId}` : 
        `${API_BASE}/api/expenses`;
      
      try {
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            amount,
            description,
            paidBy,
            splitType,
            shares,
            category
          })
        });
        
        if (response.ok) {
          const expense = await response.json();
          
          // Close modal and refresh data
          expenseModal.classList.add('hidden');
          fetchData();
          createConfetti();
          
          // Add to activity feed
          addActivity(`${expenseId ? 'Updated' : 'Added'} expense: ${description}`);
          
          // Clear expense ID
          delete expenseForm.dataset.expenseId;
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Expense submission error:', error);
        alert('Failed to add/update expense');
      }
    }
    
    async function searchFriend() {
      const email = document.getElementById('friendEmail').value;
      if (!email) {
        alert('Please enter an email address');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/users?email=${email}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        const resultsContainer = document.getElementById('friendSearchResults');
        resultsContainer.innerHTML = '';
        
        if (response.ok) {
          const users = await response.json();
          const filteredUsers = users.filter(user => 
            user.email === email && 
            user._id !== currentUser._id
          );
          
          if (filteredUsers.length === 0) {
            resultsContainer.innerHTML = '<p class="text-center py-2">No user found with that email</p>';
            resultsContainer.classList.remove('hidden');
            return;
          }
          
          filteredUsers.forEach(user => {
            const userElement = document.createElement('div');
            userElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            userElement.innerHTML = `
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                  <img src="${user.avatar}" class="w-full h-full object-cover">
                </div>
                <span>${user.username}</span>
              </div>
              <button class="btn-primary px-3 py-1 add-friend-btn" data-userid="${user._id}">
                <i class="fas fa-user-plus mr-1"></i> Add
              </button>
            `;
            resultsContainer.appendChild(userElement);
          });
          
          // Add event listeners to new buttons
          document.querySelectorAll('.add-friend-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const userId = btn.getAttribute('data-userid');
              sendFriendRequest(userId);
            });
          });
          
          resultsContainer.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Friend search error:', error);
        alert('Failed to search for friend');
      }
    }
    
    async function sendFriendRequest(toUserId) {
      try {
        const response = await fetch(`${API_BASE}/api/friends/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ toUserId })
        });
        
        if (response.ok) {
          const request = await response.json();
          alert(`Friend request sent to ${request.to.username}!`);
          friendModal.classList.add('hidden');
          document.getElementById('friendSearchResults').classList.add('hidden');
          addActivity(`Sent friend request to ${request.to.username}`);
          fetchData(); // Refresh requests
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Send friend request error:', error);
        alert('Failed to send friend request');
      }
    }
    
    async function createGroupHandler() {
      const groupName = document.getElementById('groupName').value;
      
      if (!groupName) {
        alert('Please enter a group name');
        return;
      }
      
      const selectedMembers = [];
      document.querySelectorAll('.group-member-checkbox:checked').forEach(checkbox => {
        selectedMembers.push(checkbox.value);
      });
      
      try {
        const response = await fetch(`${API_BASE}/api/groups`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ 
            name: groupName,
            members: selectedMembers 
          })
        });
        
        if (response.ok) {
          const group = await response.json();
          alert(`Group "${group.name}" created!`);
          groupModal.classList.add('hidden');
          fetchData();
          addActivity(`Created group: ${group.name}`);
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Group creation error:', error);
        alert('Failed to create group');
      }
    }
    
    async function settleUpHandler() {
      try {
        const response = await fetch(`${API_BASE}/api/settlements`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ payer: currentUser._id })
        });
        
        if (response.ok) {
          const settlement = await response.json();
          alert(`Settlement of $${settlement.amount.toFixed(2)} completed successfully!`);
          fetchData();
          createConfetti();
          addActivity(`Settled up with ${settlement.to.username}`);
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Settlement error:', error);
        alert('Failed to process settlement');
      }
    }
    
    // Rendering Functions
    function updateUIAfterLogin() {
      authBtn.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Logout';
      usernameSpan.textContent = currentUser.username;
      
      // Set user avatar
      if (currentUser.avatar) {
        userAvatar.innerHTML = `<img src="${currentUser.avatar}" class="w-full h-full object-cover">`;
      } else {
        // Fallback to initials
        const initials = currentUser.username.split(' ').map(n => n[0]).join('').toUpperCase();
        userAvatar.innerHTML = initials;
        userAvatar.style.backgroundColor = '#8a2be2';
        userAvatar.style.fontSize = '1.2rem';
      }
      
      userProfile.classList.remove('hidden');
      fetchData();
    }
    
    function renderFriends(balances) {
      friendsList.innerHTML = '';
      
      if (balances.length === 0) {
        friendsList.innerHTML = '<p class="text-center py-4 text-gray-500">No friends yet</p>';
        return;
      }
      
      balances.forEach(balance => {
        if (balance.userId === currentUser._id) return;
        
        const friend = allUsers.find(u => u._id === balance.userId);
        if (!friend) return;
        
        const balanceClass = balance.balance > 0 
          ? 'bg-green-100 text-green-800' 
          : balance.balance < 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
        
        const balanceText = balance.balance > 0 
          ? `You owe $${Math.abs(balance.balance).toFixed(2)}` 
          : balance.balance < 0 ? `Owes you $${Math.abs(balance.balance).toFixed(2)}` : 'Settled up';
        
        const friendElement = document.createElement('div');
        friendElement.className = 'flex items-center justify-between';
        friendElement.innerHTML = `
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
              <img src="${friend.avatar}" class="w-full h-full object-cover">
            </div>
            <span>${friend.username}</span>
          </div>
          <span class="px-3 py-1 ${balanceClass} rounded-full text-sm">${balanceText}</span>
        `;
        
        friendsList.appendChild(friendElement);
      });
    }
    
    function renderExpenses(expenses) {
      expensesContainer.innerHTML = '';
      
      if (expenses.length === 0) {
        expensesContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No expenses yet</p>';
        return;
      }
      
      expenses.forEach(expense => {
        const date = new Date(expense.createdAt).toLocaleDateString();
        const paidByCurrent = expense.paidBy._id === currentUser._id;
        const payerName = expense.paidBy.username;
        const canEdit = paidByCurrent; // Only payer can edit
        
        const expenseElement = document.createElement('div');
        expenseElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-xl relative';
        expenseElement.innerHTML = `
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-xl overflow-hidden mr-4">
              <img src="${expense.paidBy.avatar}" class="w-full h-full object-cover">
            </div>
            <div>
              <h3 class="font-medium">${expense.description}</h3>
              <p class="text-gray-500 text-sm">Paid by ${payerName} • ${date}</p>
              <div class="mt-1 flex flex-wrap gap-1">
                ${expense.shares.map(share => `
                  <span class="text-xs bg-gray-100 px-2 py-1 rounded">${share.user.username}: $${share.amount.toFixed(2)}</span>
                `).join('')}
              </div>
            </div>
          </div>
          <div class="text-right">
            <p class="font-medium">$${expense.amount.toFixed(2)}</p>
            <p class="text-sm ${paidByCurrent ? 'text-green-600' : 'text-red-600'}">
              ${paidByCurrent ? 'You paid' : 'You borrowed'}
            </p>
            ${canEdit ? `
              <div class="mt-2 flex justify-end gap-2">
                <button class="edit-expense text-blue-500" data-id="${expense._id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-expense text-red-500" data-id="${expense._id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            ` : ''}
          </div>
        `;
        
        expensesContainer.appendChild(expenseElement);
      });
      
      // Add event listeners for edit/delete
      document.querySelectorAll('.edit-expense').forEach(btn => {
        btn.addEventListener('click', () => {
          const expenseId = btn.getAttribute('data-id');
          editExpense(expenseId);
        });
      });
      
      document.querySelectorAll('.delete-expense').forEach(btn => {
        btn.addEventListener('click', () => {
          const expenseId = btn.getAttribute('data-id');
          deleteExpense(expenseId);
        });
      });
    }
    
    async function editExpense(expenseId) {
      try {
        const response = await fetch(`${API_BASE}/api/expenses/${expenseId}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const expense = await response.json();
          expenseModalTitle.textContent = 'Edit Expense';
          expenseSubmitBtn.textContent = 'Update Expense';
          populatePayerDropdown();
          populateExpenseForm(expense);
          expenseModal.classList.remove('hidden');
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Edit expense error:', error);
        alert('Failed to load expense for editing');
      }
    }
    
    function populateExpenseForm(expense) {
      document.getElementById('expenseDesc').value = expense.description;
      document.getElementById('expenseAmount').value = expense.amount;
      document.getElementById('expenseCategory').value = expense.category;
      document.getElementById('expensePayer').value = expense.paidBy._id;
      document.getElementById('expenseSplitType').value = expense.splitType;
      
      // Store expense ID for update
      expenseForm.dataset.expenseId = expense._id;
    }
    
    async function deleteExpense(expenseId) {
      if (!confirm('Are you sure you want to delete this expense?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/expenses/${expenseId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          fetchData();
          addActivity(`Deleted an expense`);
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Delete expense error:', error);
        alert('Failed to delete expense');
      }
    }
    
    function renderSettlements(settlements) {
      settlementsContainer.innerHTML = '';
      
      if (settlements.length === 0) {
        settlementsContainer.innerHTML = '<p class="text-center py-4 text-gray-500">No settlements needed</p>';
        return;
      }
      
      settlements.forEach(settlement => {
        const isPayer = settlement.fromId === currentUser._id;
        
        const settlementElement = document.createElement('div');
        settlementElement.className = 'flex items-center justify-between p-3 bg-blue-50 rounded-lg';
        settlementElement.innerHTML = `
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full ${isPayer ? 'bg-red-100' : 'bg-green-100'} flex items-center justify-center mr-3">
              <i class="fas fa-${isPayer ? 'arrow-up text-red-500' : 'arrow-down text-green-500'}"></i>
            </div>
            <span>${isPayer ? `You pay ${settlement.to}` : `${settlement.from} pays you`}</span>
          </div>
          <span class="font-medium">$${settlement.amount.toFixed(2)}</span>
        `;
        
        settlementsContainer.appendChild(settlementElement);
      });
    }
    
    function renderGroups(groups) {
      groupsList.innerHTML = '';
      
      if (groups.length === 0) {
        groupsList.innerHTML = '<p class="text-center py-4 text-gray-500">No groups yet</p>';
        return;
      }
      
      groups.forEach(group => {
        const groupElement = document.createElement('div');
        groupElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50';
        groupElement.innerHTML = `
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-xl overflow-hidden mr-3 group-avatar">
              ${group.name.substring(0, 2).toUpperCase()}
            </div>
            <div>
              <h3 class="font-medium">${group.name}</h3>
              <p class="text-gray-500 text-sm">${group.members.length} members</p>
            </div>
          </div>
          <i class="fas fa-chevron-right text-gray-400"></i>
        `;
        
        groupsList.appendChild(groupElement);
      });
    }
    
    function renderFriendRequests(requests) {
      activityFeed.innerHTML = '';
      
      if (requests.length === 0) {
        activityFeed.innerHTML = '<p class="text-center py-4 text-gray-500">No recent activity</p>';
        return;
      }
      
      requests.forEach(request => {
        const now = new Date();
        const requestDate = new Date(request.createdAt);
        const diffMinutes = Math.floor((now - requestDate) / 60000);
        
        let timeText;
        if (diffMinutes < 1) timeText = 'Just now';
        else if (diffMinutes < 60) timeText = `${diffMinutes} min ago`;
        else if (diffMinutes < 1440) timeText = `${Math.floor(diffMinutes/60)} hours ago`;
        else timeText = `${Math.floor(diffMinutes/1440)} days ago`;
        
        const activityElement = document.createElement('div');
        activityElement.className = 'activity-item';
        activityElement.innerHTML = `
          <div class="flex items-start">
            <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
              <img src="${request.from.avatar}" class="w-full h-full object-cover">
            </div>
            <div>
              <p class="font-medium">${request.from.username} sent you a friend request</p>
              <p class="text-gray-500 text-sm">${timeText}</p>
              <div class="flex space-x-2 mt-2">
                <button class="accept-request px-3 py-1 bg-green-500 text-white rounded-lg text-sm" data-id="${request._id}">
                  <i class="fas fa-check mr-1"></i> Accept
                </button>
                <button class="reject-request px-3 py-1 bg-red-500 text-white rounded-lg text-sm" data-id="${request._id}">
                  <i class="fas fa-times mr-1"></i> Reject
                </button>
              </div>
            </div>
          </div>
        `;
        
        activityFeed.appendChild(activityElement);
      });
      
      // Add event listeners
      document.querySelectorAll('.accept-request').forEach(btn => {
        btn.addEventListener('click', () => {
          const requestId = btn.getAttribute('data-id');
          respondToRequest(requestId, 'ACCEPTED');
        });
      });
      
      document.querySelectorAll('.reject-request').forEach(btn => {
        btn.addEventListener('click', () => {
          const requestId = btn.getAttribute('data-id');
          respondToRequest(requestId, 'REJECTED');
        });
      });
    }
    
    async function respondToRequest(requestId, status) {
      try {
        const response = await fetch(`${API_BASE}/api/friends/request/${requestId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          const result = await response.json();
          alert(`Friend request ${status.toLowerCase()}!`);
          fetchData(); // Refresh data
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        console.error('Request response error:', error);
        alert('Failed to respond to request');
      }
    }
    
    function populatePayerDropdown() {
      const payerSelect = document.getElementById('expensePayer');
      payerSelect.innerHTML = '';
      
      allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user._id;
        option.textContent = user.username;
        if (user._id === currentUser._id) {
          option.selected = true;
        }
        payerSelect.appendChild(option);
      });
    }
    
    function populateGroupMembers() {
      const container = document.getElementById('groupMembers');
      container.innerHTML = '';
      
      // Get friends (excluding current user)
      const friends = allUsers.filter(user => 
        user._id !== currentUser._id && 
        currentUser.friends?.includes(user._id)
      );
      
      if (friends.length === 0) {
        container.innerHTML = '<p class="text-center py-4 text-gray-500">Add friends first to create a group</p>';
        return;
      }
      
      friends.forEach(friend => {
        const memberElement = document.createElement('div');
        memberElement.className = 'flex items-center p-2 hover:bg-gray-50 rounded';
        memberElement.innerHTML = `
          <input type="checkbox" class="group-member-checkbox mr-3" value="${friend._id}" id="member-${friend._id}">
          <label for="member-${friend._id}" class="flex items-center flex-grow cursor-pointer">
            <div class="w-8 h-8 rounded-full overflow-hidden mr-2">
              <img src="${friend.avatar}" class="w-full h-full object-cover">
            </div>
            <span>${friend.username}</span>
          </label>
        `;
        container.appendChild(memberElement);
      });
    }
    
    function addActivity(message) {
      const now = new Date();
      const activityElement = document.createElement('div');
      activityElement.className = 'flex items-start';
      activityElement.innerHTML = `
        <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
          <img src="${currentUser.avatar}" class="w-full h-full object-cover">
        </div>
        <div>
          <p class="font-medium">${message}</p>
          <p class="text-gray-500 text-sm">Just now</p>
        </div>
      `;
      
      activityFeed.prepend(activityElement);
    }
    
    function createConfetti() {
      const colors = ['#ec4899', '#8b5cf6', '#3A86FF', '#FFBE0B', '#FB5607'];
      const container = document.body;
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = `${Math.random() * 2}s`;
        container.appendChild(confetti);
        
        setTimeout(() => {
          confetti.remove();
        }, 3000);
      }
    }
  </script>
</body>
</html>